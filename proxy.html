<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Service-Worker-Allowed" content="/" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Proxy Loader</title>
  <style>
    body { margin:0; font-family:sans-serif; }
    #loader {
      position:fixed;top:50%;left:50%;
      transform:translate(-50%,-50%);
      background:rgba(255,255,255,0.9);
      padding:1em 2em; border-radius:4px;
      box-shadow:0 2px 8px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="loader">Loadingâ€¦</div>
  <script>
    const REMOTE = 'https://4sp.koyeb.app';

    // 1) Register & activate SW
    async function initSW() {
      if (!('serviceWorker' in navigator)) return;
      const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
      await navigator.serviceWorker.ready;
      console.log('SW active:', reg.active);
    }

    // 2) Fetch + inject page
    async function load(path = '/') {
      document.getElementById('loader').style.display = 'block';
      try {
        const res = await fetch(path, { mode: 'same-origin' });
        if (!res.ok) throw new Error(res.statusText);
        const html = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Replace <head>
        document.title = doc.title;
        document.head.innerHTML = '';
        doc.head.childNodes.forEach(n => {
          const clone = n.cloneNode(true);
          // rewrite relative href/src in <link> & <script>
          if (clone.href && clone.getAttribute('href')?.startsWith('/')) {
            clone.href = location.origin + clone.getAttribute('href');
          }
          if (clone.src && clone.getAttribute('src')?.startsWith('/')) {
            clone.src = location.origin + clone.getAttribute('src');
          }
          document.head.appendChild(clone);
        });

        // Replace <body>
        document.body.innerHTML = '';
        doc.body.childNodes.forEach(n => {
          if (n.nodeType === Node.ELEMENT_NODE) {
            // rewrite relative href/src everywhere
            if (n.hasAttribute('href') && n.getAttribute('href').startsWith('/')) {
              n.setAttribute('href', location.origin + n.getAttribute('href'));
            }
            if (n.hasAttribute('src') && n.getAttribute('src').startsWith('/')) {
              n.setAttribute('src', location.origin + n.getAttribute('src'));
            }
          }
          document.body.appendChild(n.cloneNode(true));
        });

        // 3) Hijack all same-origin links
        document.querySelectorAll('a[href^="' + location.origin + '"]').forEach(a => {
          a.addEventListener('click', e => {
            e.preventDefault();
            const url = new URL(a.href);
            history.pushState({}, '', url.pathname + url.search);
            load(url.pathname + url.search);
          });
        });

      } catch (err) {
        document.body.innerHTML = '<h1>Unable to load site</h1><p>' + err + '</p>';
      } finally {
        document.getElementById('loader').style.display = 'none';
      }
    }

    // 4) Handle back/forward
    window.addEventListener('popstate', () => load(location.pathname + location.search));

    // bootstrap
    (async () => {
      await initSW();
      await load(location.pathname + location.search);
    })();
  </script>
</body>
</html>
