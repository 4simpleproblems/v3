<!-- playlist-detail.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4SP | Playlist Details</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    * { font-family: 'Roboto Mono', monospace; box-sizing: border-box; }
    :root {
      --black: #000;
      --white: #fff;
      --light-gray: #f0f0f0;
      --dark-gray: #333;
      --pill-radius: 50px;
      --card-radius: 24px;
    }
    body { margin:0; background:var(--light-gray); color:var(--black); }
    .header {
      background: var(--dark-gray); color: var(--white);
      padding: 1rem 2rem; display: flex;
      justify-content: space-between; align-items: center;
    }
    .header h2, .header p { margin: 0; }
    .header p { font-size: .9rem; opacity: .8; }
    .header .btn { margin-left: .5rem; }
    .btn {
      padding: .75rem 1.5rem; border-radius: var(--pill-radius);
      background: transparent; border: 2px solid var(--white);
      color: var(--white); cursor: pointer; font-weight: 500;
      transition: background .2s, color .2s;
    }
    .btn:hover { background: var(--white); color: var(--dark-gray); }
    .btn.primary { background: var(--white); color: var(--dark-gray); border: none; }
    #content { padding: 1rem 2rem; }
    .sound-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px,1fr));
      gap: .75rem; justify-items: center;
    }
    .sound-btn {
      min-width: 80px; height: 80px; border-radius: var(--pill-radius);
      background: var(--white); color: var(--dark-gray);
      border: 2px solid var(--dark-gray);
      display: flex; align-items: center; justify-content: center;
      text-align: center; padding: 0 .5rem;
      cursor: pointer; transition: background .2s;
      word-wrap: break-word; hyphens: auto;
    }
    .sound-btn.short-text { border-radius: 50%; padding: .5rem; }
    .sound-btn:hover { background: var(--light-gray); }
    .overlay {
      display: none; position: fixed; top:0; left:0;
      width:100%; height:100%; background: rgba(0,0,0,0.7);
      z-index: 1; opacity:0; transition: opacity .3s;
    }
    .overlay.show { display: block; opacity:1; }
    .overlay.hide { opacity:0; }
    .editing .sound-btn { opacity: .3; }
    .editing .sound-btn:hover { opacity: 1; }
  </style>
</head>
<body>
  <nav class="header">
    <div>
      <h2 id="plName">Playlist Name</h2>
      <p id="plDesc">Playlist Description</p>
    </div>
    <div>
      <button id="editBtn" class="btn">Edit</button>
      <button id="saveBtn" class="btn primary" style="display:none;">Save</button>
    </div>
  </nav>

  <div class="overlay" id="overlay"></div>
  <main id="content">
    <div id="soundGrid" class="sound-grid"></div>
  </main>

  <script>
    const auth = firebase.auth();
    const db = firebase.firestore();
    const params = new URLSearchParams(location.search);
    const playlistId = params.get('id');
    const isLocal = params.get('local') === 'true';
    let playlistData = { items: [] };

    const plName = document.getElementById('plName');
    const plDesc = document.getElementById('plDesc');
    const soundGrid = document.getElementById('soundGrid');
    const editBtn = document.getElementById('editBtn');
    const saveBtn = document.getElementById('saveBtn');
    const overlay = document.getElementById('overlay');

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = 'index.html';
      if (isLocal) {
        const list = JSON.parse(localStorage.getItem('localPlaylists')||'[]');
        playlistData = list.find(p => p.id === playlistId) || {};
      } else {
        const doc = await db.collection('playlists').doc(playlistId).get();
        if (!doc.exists || doc.data().owner !== user.uid) return location.href = 'playlist.html';
        playlistData = doc.data();
      }
      render();
    });

    function render() {
      plName.textContent = playlistData.name || '';
      plDesc.textContent = playlistData.description || '';
      soundGrid.innerHTML = '';
      playlistData.items.forEach((item, idx) => {
        const btn = document.createElement('div');
        btn.className = 'sound-btn';
        const label = item.label || item.fileName;
        btn.textContent = label;
        if (label.length < 8) btn.classList.add('short-text');
        btn.addEventListener('click', () => {
          if (document.body.classList.contains('editing')) return;
          let src = item.url || `${item.folder}/${item.fileName}`;
          const audio = new Audio(src);
          audio.play();
        });
        soundGrid.appendChild(btn);
      });
    }

    editBtn.onclick = () => {
      document.body.classList.add('editing');
      overlay.classList.add('show');
      editBtn.style.display = 'none';
      saveBtn.style.display = 'inline-block';
    };

    overlay.onclick = () => closeEdit();

    saveBtn.onclick = async () => {
      playlistData.name = plName.textContent.trim();
      playlistData.description = plDesc.textContent.trim();
      if (isLocal) {
        const list = JSON.parse(localStorage.getItem('localPlaylists')||'[]');
        const idx = list.findIndex(p => p.id === playlistId);
        if (idx > -1) list[idx] = playlistData;
        localStorage.setItem('localPlaylists', JSON.stringify(list));
      } else {
        await db.collection('playlists').doc(playlistId)
          .update({ name: playlistData.name, description: playlistData.description });
      }
      closeEdit();
    };

    function closeEdit() {
      overlay.classList.remove('show'); overlay.classList.add('hide');
      setTimeout(() => overlay.classList.remove('hide'), 300);
      document.body.classList.remove('editing');
      editBtn.style.display = 'inline-block';
      saveBtn.style.display = 'none';
    }
  </script>
</body>
</html>
