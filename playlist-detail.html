<!-- playlist-detail.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4SP | Playlist Details</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    * { font-family: 'Roboto Mono', monospace; box-sizing: border-box; }
    :root { --dark-bg: #1a1a1a; --light-text: #f0f0f0; --white: #fff; --pill-radius: 50px; }
    body { margin:0; background:var(--white); color:var(--dark-bg); }
    .navbar { display:flex; justify-content:space-between; align-items:center; background:var(--dark-bg); color:var(--light-text); padding:1rem 2rem; }
    .logo-section { display:flex; align-items:center; gap:1rem; }
    .logo { font-size:1.5rem; font-weight:bold; }
    .title-section h2 { margin:0; font-size:1.25rem; }
    .title-section p { margin:0; font-size:.9rem; opacity:.8; }
    .nav-buttons { display:flex; gap:1rem; }
    .btn { padding:.75rem 1.5rem; border-radius:var(--pill-radius); background:transparent; border:2px solid var(--light-text); color:var(--light-text); cursor:pointer; font-weight:500; transition:background .2s, color .2s; }
    .btn.big { padding:1rem 2rem; font-size:1.1rem; }
    .btn:hover { background:var(--light-text); color:var(--dark-bg); }
    .container { padding:1rem 2rem; }
    .sound-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(80px,1fr)); gap:.75rem; justify-items:center; }
    .sound-btn { background:var(--light-text); color:var(--dark-bg); border:2px solid var(--dark-bg); border-radius:var(--pill-radius); min-width:80px; height:80px; display:flex; align-items:center; justify-content:center; text-align:center; padding:0 .5rem; cursor:pointer; user-select:none; }
    .sound-btn.short-text { border-radius:50%; padding:.5rem; }
    .overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); display:none; }
    .overlay.show { display:block; }
    .editing .sound-btn { opacity:.5; }
    .editing .sound-btn.dragging { opacity:.2; }
    .editing .sound-btn:hover { opacity:1; }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo-section">
      <div class="logo">4SP</div>
      <div class="title-section">
        <h2 id="plName"></h2>
        <p id="plDesc"></p>
      </div>
    </div>
    <div class="nav-buttons">
      <button id="editBtn" class="btn big">Edit</button>
      <button id="saveBtn" class="btn big" style="display:none;">Save</button>
      <button id="backBtn" class="btn big">Playlists</button>
      <button id="logoutBtn" class="btn big">Log Out</button>
    </div>
  </nav>

  <div class="overlay" id="overlay"></div>
  <main class="container">
    <div id="soundGrid" class="sound-grid"></div>
  </main>

  <script>
    const auth = firebase.auth(), db = firebase.firestore();
    const params = new URLSearchParams(location.search);
    const playlistId = params.get('id');
    const isLocal = params.get('local')==='true';
    let data = {items:[]};
    const plName=document.getElementById('plName'), plDesc=document.getElementById('plDesc');
    const grid=document.getElementById('soundGrid');
    const editBtn=document.getElementById('editBtn'), saveBtn=document.getElementById('saveBtn');
    const backBtn=document.getElementById('backBtn'), logoutBtn=document.getElementById('logoutBtn');
    const overlay=document.getElementById('overlay');

    auth.onAuthStateChanged(async user=>{
      if(!user) return location.href='index.html';
      if(isLocal){
        const list=JSON.parse(localStorage.getItem('localPlaylists')||'[]');
        data=list.find(p=>p.id===playlistId)||{};
      } else {
        const doc=await db.collection('playlists').doc(playlistId).get();
        if(!doc.exists||doc.data().owner!==user.uid) return location.href='playlist.html';
        data=doc.data();
      }
      plName.textContent=data.name; plDesc.textContent=data.description;
      render();
    });

    function render(){
      grid.innerHTML='';
      data.items.forEach((item,i)=>{
        const btn=document.createElement('div');
        btn.className='sound-btn';
        const label=item.label||item.fileName;
        btn.textContent=label;
        if(label.length<8) btn.classList.add('short-text');
        btn.draggable=document.body.classList.contains('editing');
        btn.dataset.index=i;
        btn.onclick=()=>{ if(!document.body.classList.contains('editing')) new Audio(item.url||`${item.folder}/${item.fileName}`).play(); };
        grid.appendChild(btn);
      });
    }

    // Drag and drop on grid
    grid.addEventListener('dragstart',e=>{
      if(!document.body.classList.contains('editing')){ e.preventDefault(); return; }
      e.target.classList.add('dragging');
      e.dataTransfer.setData('text/plain',e.target.dataset.index);
    });
    grid.addEventListener('dragend',e=>{ e.target.classList.remove('dragging'); });
    grid.addEventListener('dragover',e=>{
      if(!document.body.classList.contains('editing')) return;
      e.preventDefault();
      const dragging=document.querySelector('.dragging');
      const afterElement=getDragAfterElement(e.clientY);
      if(afterElement==null) grid.appendChild(dragging);
      else grid.insertBefore(dragging,afterElement);
    });
    grid.addEventListener('drop',e=>{
      e.preventDefault();
      // recompute data.items order from DOM
      const newItems=[];
      grid.querySelectorAll('.sound-btn').forEach(btn=>{
        const idx=parseInt(btn.dataset.index);
        newItems.push(data.items[idx]);
      });
      data.items=newItems;
    });
    function getDragAfterElement(y){
      const draggable=document.querySelector('.dragging');
      const elems=[...grid.querySelectorAll('.sound-btn:not(.dragging)')];
      return elems.reduce((closest,child)=>{
        const box=child.getBoundingClientRect();
        const offset=y-box.top-box.height/2;
        if(offset<0&&offset>closest.offset) return {offset:offset,element:child};
        else return closest;
      },{offset:Number.NEGATIVE_INFINITY}).element;
    }

    editBtn.onclick=()=>{ document.body.classList.add('editing'); overlay.classList.add('show'); editBtn.style.display='none'; saveBtn.style.display='inline-block'; };
    overlay.onclick=closeEdit;
    saveBtn.onclick=async()=>{
      data.name=plName.textContent.trim(); data.description=plDesc.textContent.trim();
      if(!isLocal) await db.collection('playlists').doc(playlistId).update({name:data.name,description:data.description,items:data.items});
      else{
        const list=JSON.parse(localStorage.getItem('localPlaylists')||'[]');
        localStorage.setItem('localPlaylists',JSON.stringify(list.map(p=>p.id===playlistId?data:p)));
      }
      closeEdit();
    };
    function closeEdit(){ document.body.classList.remove('editing'); overlay.classList.remove('show'); editBtn.style.display='inline-block'; saveBtn.style.display='none'; render(); }
    backBtn.onclick=()=>location.href='playlist.html'; logoutBtn.onclick=()=>auth.signOut().then(()=>location.href='index.html');
  </script>
</body>
</html>
