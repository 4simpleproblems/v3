<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4SP | Create Playlist</title>
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="logo">4SP</div>
    <div class="nav-buttons">
      <a href="playlists.html" class="btn secondary">← Back</a>
    </div>
  </nav>
  <main class="container" style="max-width:600px;">
    <h1>Create Playlist</h1>
    <form id="playlistForm" class="card">
      <label>Name (max 20 chars)
        <input id="plName" type="text" maxlength="20" required>
      </label>
      <label>Description (max 60 chars)
        <textarea id="plDesc" maxlength="60"></textarea>
      </label>
      <label>Type
        <select id="plType">
          <option value="normal">Normal</option>
          <option value="local">Local</option>
        </select>
      </label>
      <div id="soundsSection" class="sounds-list"></div>
      <button type="submit" class="btn primary btn-save">Save Playlist</button>
    </form>
  </main>
  <script>
    const form = document.getElementById('playlistForm'), sect = document.getElementById('soundsSection');
    let manifest;
    fetch('SoundboardSN.json').then(r => r.json()).then(m => manifest = m);

    document.getElementById('plType').addEventListener('change', renderSounds);

    function renderSounds() {
      sect.innerHTML = '';
      if (plType.value === 'normal') {
        ['NormalSounds', 'ExplicitSounds'].forEach(folder => {
          if (manifest && manifest[folder]) {
            manifest[folder].forEach(file => {
              const item = document.createElement('div'); item.className = 'sound-item';
              const chk = document.createElement('input'); chk.type = 'checkbox'; chk.value = folder + '/' + file;
              const btn = document.createElement('button'); btn.type = 'button'; btn.textContent = '▶'; btn.onclick = () => new Audio(folder + '/' + file).play();
              const nameIn = document.createElement('input'); nameIn.className = 'name-edit'; nameIn.value = file.replace('.mp3', '');
              item.append(chk, btn, nameIn);
              sect.appendChild(item);
            });
          }
        });
      } else {
        for (let i = 0; i < 5; i++) {
          const item = document.createElement('div'); item.className = 'sound-item';
          const fileIn = document.createElement('input'); fileIn.type = 'file'; fileIn.accept = 'audio/*';
          const nameIn = document.createElement('input'); nameIn.className = 'name-edit'; nameIn.placeholder = 'Button label';
          const btnDel = document.createElement('button'); btnDel.type = 'button'; btnDel.textContent = '✕'; btnDel.style.background = '#b71c1c'; btnDel.onclick = e => item.remove();
          item.append(fileIn, nameIn, btnDel);
          sect.appendChild(item);
        }
      }
    }

    form.addEventListener('submit', e => {
      e.preventDefault();
      const name = plName.value, desc = plDesc.value, type = plType.value;
      if (type === 'normal') {
        const sounds = [];
        sect.querySelectorAll('.sound-item').forEach(i => {
          const chk = i.querySelector('input[type=checkbox]');
          if (chk && chk.checked) {
            sounds.push({ path: chk.value, label: i.querySelector('.name-edit').value });
          }
        });
        firebase.auth().onAuthStateChanged(u => {
          const db = firebase.firestore();
          db.collection('users').doc(u.uid).collection('playlists').add({ name, description: desc, type, sounds }).then(() => location = 'playlists.html');
        });
      } else {
        const local = JSON.parse(localStorage.getItem('localPlaylists') || '[]');
        if (local.length >= 3) { alert('Max 3 local playlists'); return; }
        const sounds = [];
        sect.querySelectorAll('.sound-item').forEach(i => {
          const f = i.querySelector('input[type=file]').files[0];
          if (f) {
            sounds.push({ fileName: f.name, label: i.querySelector('.name-edit').value, url: URL.createObjectURL(f) });
          }
        });
        const id = Date.now().toString();
        local.push({ id, name, description: desc, type, sounds });
        localStorage.setItem('localPlaylists', JSON.stringify(local));
        location = 'playlists.html';
      }
    });

    document.addEventListener('DOMContentLoaded', renderSounds);
  </script>
</body>
</html>
