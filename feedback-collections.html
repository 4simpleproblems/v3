<!-- feedback-collections.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP | Feedback Collections</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        * { font-family: 'Roboto Mono', monospace !important; text-decoration: none !important; box-sizing: border-box; }
        :root { --light-gray: #e0e0e0; --dark-bg: #1a1a1a; --darker-bg: #0d0d0d; --light-text: #f0f0f0; --pill-radius: 50px; --card-radius: 24px; }
        body { background-color: var(--light-gray); color: var(--dark-bg); margin: 0; padding: 0; min-height: 100vh; }
        .navbar { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 3rem; background-color: var(--darker-bg); color: var(--light-text); }
        .logo { font-size: 1.8rem; font-weight: 700; }
        .nav-buttons { display: flex; gap: 1.5rem; }
        .btn { padding: 1rem 2rem; border-radius: var(--pill-radius); font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        .btn.secondary { background-color: transparent; color: var(--light-text); border: 2px solid var(--light-text); }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 2rem; display: flex; flex-direction: column; }
        .filter-container { margin-bottom: 2rem; display: flex; align-items: center; gap: 1rem; }
        .filter-label { font-weight: 500; margin-right: 0.5rem; }
        select { padding: 0.75rem 2rem 0.75rem 1rem; border-radius: var(--pill-radius); font-size: 1rem; border: 2px solid var(--dark-bg); cursor: pointer; background-color: white; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%231a1a1a' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; }
        .requests-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; flex: 1; }
        .request-card { background: white; border-radius: var(--card-radius); padding: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .request-card .category-badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: var(--pill-radius); font-size: 0.75rem; margin-bottom: 0.5rem; color: white; }
        .category-badge.feedback { background-color: #3498db; }
        .category-badge.feature { background-color: #2ecc71; }
        .category-badge.proxy { background-color: #e74c3c; }
        #loadingMessage { text-align: center; padding: 2rem; }
        .section-title { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="logo">4SP</div>
        <div class="nav-buttons">
            <a href="feedback.html" class="btn secondary">Submit Feedback</a>
            <button id="logoutBtn" class="btn secondary">Log Out</button>
        </div>
    </nav>

    <main class="container">
        <div class="section-title">
            <h1>Feedback Collection</h1>
            <div class="filter-container">
                <span class="filter-label">View:</span>
                <select id="categoryFilter">
                    <option value="all">All Submissions</option>
                    <option value="feedback">Feedback</option>
                    <option value="feature">Feature Requests</option>
                    <option value="proxy">Proxy Reports</option>
                </select>
            </div>
        </div>
        <div id="feedbackContainer" class="requests-grid">
            <p id="loadingMessage">Loading submissions...</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const db = firebase.firestore(), auth = firebase.auth();
            const container = document.getElementById('feedbackContainer');
            const logoutBtn = document.getElementById('logoutBtn');
            const categoryFilter = document.getElementById('categoryFilter');
            const adminEmail = '4simpleproblems@gmail.com';
            let allItems = [];

            auth.onAuthStateChanged(user => {
                if (!user) return window.location.href = 'index.html';
                if (user.email !== adminEmail) return window.location.href = 'feedback.html';
                
                db.collection('feedback').orderBy('timestamp', 'desc').onSnapshot(snap => {
                    allItems = snap.docs.map(d => ({ 
                        id: d.id, 
                        ...d.data(), 
                        timestamp: d.data().timestamp?.toDate(),
                        // Set default category for older entries that don't have one
                        category: d.data().category || 'feedback'
                    }));
                    filterAndRender();
                }, e => container.innerHTML = '<p>Error loading submissions</p>');
            });

            categoryFilter.addEventListener('change', filterAndRender);

            function filterAndRender() {
                const selectedCategory = categoryFilter.value;
                const filteredItems = selectedCategory === 'all' 
                    ? allItems 
                    : allItems.filter(item => item.category === selectedCategory);
                
                render(filteredItems);
            }

            function render(list) {
                if (!list.length) return container.innerHTML = '<p>No submissions found</p>';
                
                container.innerHTML = list.map(item => {
                    // Get category display name
                    let categoryName = 'Feedback';
                    if (item.category === 'feature') categoryName = 'Feature Request';
                    if (item.category === 'proxy') categoryName = 'Proxy Report';
                    
                    return `
                    <div class="request-card">
                        <span class="category-badge ${item.category}">${categoryName}</span>
                        <h3>${item.title}</h3>
                        <p>${item.description}</p>
                        <div class="request-meta">
                            <span>${item.timestamp?.toLocaleString() || ''}</span>
                            <span>| From: ${item.submittedBy}</span>
                        </div>
                    </div>`;
                }).join('');
            }

            logoutBtn.addEventListener('click', () => auth.signOut().then(() => window.location.href = 'index.html'));
        });
    </script>
</body>
</html>
