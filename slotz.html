<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>4SP | SLOTZ</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet"/>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        * {
            font-family: 'Outfit', sans-serif;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #ffffff; /* Light background */
            --text-color: #333333; /* Dark text */
            --primary-color: #333333; /* Dark primary for contrast on light */
            --secondary-border-color: #cccccc; /* Medium gray border */
            --navbar-bg: #f0f0f0; /* Light gray for navbar */
            --footer-bg: #f0f0f0; /* Light gray for footer */
            --hover-bg: #e0e0e0; /* Lighter gray on hover */
            --grid-line-color: #f0f0f0; /* Light gray grid lines */
            --accent-color: #333333; /* Dark accent color */

            /* Game specific colors (adapted for light theme) */
            --reel-border-color: var(--secondary-border-color);
            --reel-number-color: var(--primary-color);
            --win-message-color-x2: #28a745; /* Green */
            --win-message-color-x3: #ffc107; /* Yellow */
            --lose-message-color: #dc3545; /* Red */
            --confetti-color: var(--accent-color);
            --input-border-color: var(--secondary-border-color);
            --input-bg-color: var(--bg-color);
            --input-text-color: var(--text-color);
            --input-focus-border-color: var(--accent-color);
            --card-bg: #ffffff; /* Explicitly defined for reel background */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Outfit', sans-serif;
            line-height: 1.6;
            text-transform: uppercase;
            text-align: center;
            position: relative;
            overflow-x: hidden;
            padding-top: 80px;
            padding-bottom: 60px;
            background-image: repeating-linear-gradient(0deg, var(--grid-line-color), var(--grid-line-color) 1px, transparent 1px, transparent 20px),
                                  repeating-linear-gradient(90deg, var(--grid-line-color), var(--grid-line-color) 1px, transparent 1px, transparent 20px);
            background-size: 20px 20px;
        }

        body::before, body::after {
            content: none;
        }

        a {
            color: var(--text-color);
            text-decoration: none;
        }

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 20px;
            background-color: var(--navbar-bg);
            color: var(--text-color);
            text-align: left;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 900;
            color: var(--text-color);
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            align-items: center;
            text-align: left;
            margin-left: auto;
        }

        /* Buttons (Base Styles) */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 20px;
            min-height: 40px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-family: 'Outfit', sans-serif;
            text-transform: uppercase;
            font-size: 14px;
            text-align: center;
        }

        .btn.primary {
            background-color: var(--primary-color);
            color: var(--bg-color);
            border: 1px solid var(--primary-color);
        }

        .btn.secondary {
            background-color: transparent;
            color: var(--text-color);
            border: 1px solid var(--secondary-border-color);
        }

        .btn.primary:hover {
            background-color: var(--hover-bg);
            color: var(--text-color);
            border-color: var(--hover-bg);
        }

        .btn.secondary:hover {
            background-color: var(--hover-bg);
            border-color: var(--hover-bg);
        }

        /* Button with Arrow */
        .btn-with-arrow::before {
            content: '\2192';
            margin-right: 8px;
            font-weight: bold;
            color: var(--accent-color);
        }

        /* Slot Machine Title */
        h1 {
            margin: 2rem 0 1rem;
            font-size: 3rem;
            letter-spacing: normal;
            color: var(--primary-color);
            font-weight: 900;
            text-transform: uppercase;
            animation: none;
        }

        /* Controls Area */
        #controls {
            display: flex;
            gap: 1.5rem;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Input and Button within Controls */
        #controls input[type="number"],
        #controls button {
            background-color: var(--input-bg-color);
            border: 1px solid var(--input-border-color);
            padding: 10px 20px;
            border-radius: 5px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            color: var(--input-text-color);
            text-transform: uppercase;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
        }

        #controls input[type="number"] {
            width: 100px;
            text-align: center;
            text-transform: none;
            padding: 10px 8px;
        }
        #controls input[type="number"]:focus {
            border-color: var(--input-focus-border-color);
            box-shadow: 0 0 5px rgba(51, 51, 51, 0.2);
        }


        #controls button#spin {
            background-color: var(--primary-color);
            color: var(--bg-color);
            border: 1px solid var(--primary-color);
            position: static;
            overflow: visible;
        }
        #controls button#spin:hover {
            background-color: var(--hover-bg);
            color: var(--text-color);
            border-color: var(--hover-bg);
            box-shadow: none;
        }
         #controls button#spin:active:after {
            content: none;
        }

        /* Spin button hard press styles */
        #spin.pressing {
            background-color: var(--accent-color);
            transform: scale(0.98);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }
        #spin.disabled-click {
            cursor: not-allowed;
            opacity: 0.7;
        }


        /* Slot Machine Reels Container */
        #slot-machine {
            display: flex;
            gap: 20px;
            margin-bottom: 1rem;
            justify-content: center;
        }

        /* Individual Reels */
        .reel {
            width: 100px;
            height: 100px;
            border: 3px solid var(--reel-border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            background-color: var(--card-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            animation: none;
        }

        .number {
            position: absolute;
            font-size: 3rem;
            color: var(--reel-number-color);
            font-weight: 900;
            text-transform: uppercase;
        }

        .reel.spinning .number {
            animation: slide 0.4s linear infinite;
            filter: blur(4px);
            text-transform: uppercase;
        }

        /* Message Area */
        #message {
            height: 1.5em;
            margin-bottom: 2rem;
            font-size: 1.5rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            text-transform: uppercase;
            font-weight: 700;
            text-align: center;
        }
        #message.win {
            animation: none;
            opacity: 1;
        }
        #message.win.x2 {
            color: var(--win-message-color-x2);
        }
        #message.win.x3 {
            color: var(--win-message-color-x3);
        }
        #message.lose {
            color: var(--lose-message-color);
            opacity: 1;
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 8px;
            height: 8px;
            background: var(--confetti-color);
            top: 0;
            opacity: 0.8;
            pointer-events: none;
            animation: fall 2s ease-out forwards;
            border-radius: 2px;
        }

        /* --- Leaderboard Styles --- */
        #leaderboards-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            margin-top: 2rem;
            width: 100%;
            max-width: 1200px;
            padding: 0 20px;
        }

        .leaderboard {
            background-color: var(--card-bg);
            border: 1px solid var(--secondary-border-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 350px; /* Adjust as needed for layout */
            text-align: left;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* For scrolling content */
        }

        .leaderboard h2 {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }

        .leaderboard-list {
            max-height: 300px; /* Fixed height for scrolling */
            overflow-y: auto;
            border-top: 1px solid var(--grid-line-color);
            padding-top: 10px;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: var(--accent-color) var(--grid-line-color); /* Firefox */
        }

        /* Custom scrollbar for Webkit browsers */
        .leaderboard-list::-webkit-scrollbar {
            width: 8px;
        }

        .leaderboard-list::-webkit-scrollbar-track {
            background: var(--grid-line-color);
            border-radius: 10px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 10px;
            border: 2px solid var(--grid-line-color);
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed var(--grid-line-color);
            font-size: 1rem;
            color: var(--text-color);
            font-weight: 400;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-item .rank {
            font-weight: 700;
            width: 30px;
            flex-shrink: 0;
        }

        .leaderboard-item .username {
            flex-grow: 1;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }

        .leaderboard-item .score {
            font-weight: 600;
            color: var(--primary-color);
        }
        /* --- End Leaderboard Styles --- */

        /* --- Display Name Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--bg-color);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-content h3 {
            margin-top: 0;
            font-size: 1.8rem;
            color: var(--primary-color);
            margin-bottom: 20px;
        }

        .modal-content input[type="text"] {
            width: calc(100% - 20px);
            padding: 12px 10px;
            margin-bottom: 20px;
            border: 1px solid var(--secondary-border-color);
            border-radius: 5px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            color: var(--input-text-color);
            outline: none;
            text-transform: none; /* Allow normal casing for display name */
        }

        .modal-content input[type="text"]:focus {
            border-color: var(--input-focus-border-color);
            box-shadow: 0 0 5px rgba(51, 51, 51, 0.2);
        }

        .modal-content button {
            width: 100%;
            padding: 12px 20px;
            font-size: 1rem;
        }
        /* --- End Display Name Modal Styles --- */


        /* Animations */
        @keyframes slide {
            0% {
                transform: translateY(100%);
            }
            100% {
                transform: translateY(-100%);
            }
        }
        @keyframes fall {
            to {
                transform: translate(var(--dx), 100vh) rotate(var(--rot));
                opacity: 0;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
             .navbar {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

             .nav-buttons {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
                margin-left: 0;
                width: 100%;
            }

             body {
                padding-top: 120px;
                padding-bottom: 80px;
            }

             h1 {
                font-size: 2.5rem;
                margin-top: 1.5rem;
                margin-bottom: 0.8rem;
            }

             #controls {
                gap: 1rem;
                margin-bottom: 1rem;
                font-size: 0.9rem;
            }
             #controls input[type="number"], #controls button {
                 padding: 8px 15px;
                 font-size: 12px;
             }
             #controls input[type="number"] {
                 width: 80px;
                 padding: 8px 6px;
             }


             #slot-machine {
                gap: 15px;
                margin-bottom: 0.8rem;
            }
             .reel {
                width: 80px;
                height: 80px;
                border-width: 2px;
                border-radius: 8px;
            }
             .number {
                font-size: 2.5rem;
            }

             #message {
                font-size: 1.2rem;
                margin-bottom: 1.5rem;
            }

             .confetti {
                 width: 6px;
                 height: 6px;
                 border-radius: 1px;
             }

            #leaderboards-container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
                padding: 0 15px;
            }
            .leaderboard {
                max-width: 90%; /* Allow wider on smaller screens */
            }

            .modal-content {
                padding: 20px;
            }
            .modal-content h3 {
                font-size: 1.5rem;
                margin-bottom: 15px;
            }
        }

        @media (max-width: 480px) {
             .navbar {
                padding: 15px 10px;
            }
            .logo {
                font-size: 20px;
            }

             .nav-buttons {
                gap: 8px;
            }

             .btn {
                padding: 8px 15px;
                font-size: 12px;
            }

             body {
                padding-top: 150px;
                padding-bottom: 100px;
            }

             h1 {
                font-size: 1.8rem;
                margin-top: 1rem;
                margin-bottom: 0.6rem;
            }

             #controls {
                gap: 0.8rem;
                margin-bottom: 0.8rem;
                font-size: 0.8rem;
            }
             #controls input[type="number"], #controls button {
                 padding: 6px 10px;
                 font-size: 10px;
             }
             #controls input[type="number"] {
                 width: 60px;
                 padding: 6px 4px;
             }


             #slot-machine {
                gap: 10px;
                margin-bottom: 0.6rem;
            }
             .reel {
                width: 60px;
                height: 60px;
                border-width: 1px;
                border-radius: 5px;
            }
             .number {
                font-size: 1.8rem;
            }
             #message {
                font-size: 1rem;
                margin-bottom: 1rem;
            }

             .confetti {
                 width: 4px;
                 height: 4px;
                 border-radius: 0;
             }

            .leaderboard h2 {
                font-size: 1.5rem;
            }
            .leaderboard-item {
                font-size: 0.9rem;
            }
            .modal-content {
                padding: 15px;
            }
            .modal-content h3 {
                font-size: 1.2rem;
            }
            .modal-content input[type="text"], .modal-content button {
                font-size: 0.9rem;
                padding: 10px 10px;
            }
        }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="logo">4SP</div>
        <div class="nav-buttons">
             <a href="index.html" class="btn secondary btn-with-arrow">Home</a>
             <a href="dashboard.html" class="btn secondary btn-with-arrow">Dashboard</a>
             <button id="logoutBtn" class="btn secondary">Log Out</button>
        </div>
    </nav>

    <h1>Slotz</h1>

    <div id="controls">
        <div>BALANCE: <span id="balance">1000</span></div>
        <div>BET: <input type="number" id="bet" min="1" step="1" value="10"/></div>
        <button id="spin" class="primary">SPIN</button>
    </div>

    <div id="slot-machine">
        <div class="reel"><div class="number">0</div></div>
        <div class="reel"><div class="number">0</div></div>
        <div class="reel"><div class="number">0</div></div>
    </div>

    <div id="message"></div>

    <div id="leaderboards-container">
        <div class="leaderboard">
            <h2>Top Slotz Score</h2>
            <div id="leaderboard-slotz" class="leaderboard-list">
                </div>
        </div>

        <div class="leaderboard">
            <h2>Highest Risk Takers</h2>
            <div id="leaderboard-risk" class="leaderboard-list">
                </div>
        </div>
    </div>

    <div id="displayNameModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Set Your Display Name</h3>
            <p>This name will appear on the leaderboards.</p>
            <input type="text" id="displayNameInput" placeholder="Enter your unique name" maxlength="20">
            <button id="saveDisplayNameBtn" class="btn primary">Save Name</button>
        </div>
    </div>

    <script>
        // -----------------------------------------------------------
        // === RIGGING CONFIGURATION ===
        // Emails that always lose:
        const riggedToLoseEmails = [
            'enemy1@example.com',
            'jace.toot@icloud.com',
            'tootja30@minerva.sparcc.org'
        ];

        // Emails that always win:
        const riggedToWinEmails = [
            'ludwza30@minerva.sparcc.org',
            '4simpleproblems@gmail.com',
            'belkwy30@minerva.sparcc.org'
        ];
        // -----------------------------------------------------------

        // Weighted reel strips for normal play
        const strip = [
            ...Array(40).fill(1),
            ...Array(30).fill(2),
            ...Array(15).fill(3),
            ...Array(10).fill(4),
            ...Array(3).fill(5),
            ...Array(1).fill(6),
            ...Array(1).fill(7)
        ];
        const reelsData = [ shuffle(strip), shuffle(strip), shuffle(strip) ];

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function spinReelValue(reel) {
            const idx = Math.floor(Math.random() * reel.length);
            return reel[idx];
        }

        // Guaranteed-loss outcome (3 distinct symbols)
        function generateRiggedLoseOutcome(strips) {
            const allSymbols = Array.from(new Set(strips.flat()));
            let outcome;
            do {
                outcome = [
                    randomFromArray(allSymbols),
                    randomFromArray(allSymbols),
                    randomFromArray(allSymbols)
                ];
            } while (outcome[0]===outcome[1] || outcome[1]===outcome[2] || outcome[0]===outcome[2]);
            return outcome;
        }

        // Guaranteed-win outcome (all three the same)
        function generateRiggedWinOutcome(strips) {
            // pick one symbol from the full weighted strip to respect normal odds
            const combined = strips.flat();
            const symbol = combined[Math.floor(Math.random() * combined.length)];
            return [symbol, symbol, symbol];
        }

        function randomFromArray(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        const insultLossMessages = [
            'LOL, YOU LOST AGAIN!',
            'SHOULD HAVE QUIT WHILE YOU WERE BEHIND.',
            'BETTER LUCK NEVER!',
            'YOU ARE NOT WINNING THIS. EVER.',
            'LOST YOUR MONEY. CLASSIC.',
            'JUST GIVE UP ALREADY.',
            'AS EXPECTED. YOU LOST.',
            'DID YOU REALLY THINK YOU WOULD WIN?',
            'HA! ANOTHER LOSS FOR YOU.',
            'KEEP LOSING, IT\'S FUNNY.'
        ];

        // --- UI & GAME STATE ---
        const reelsEls = document.querySelectorAll('.reel .number');
        const spinBtn = document.getElementById('spin');
        const balEl = document.getElementById('balance');
        const betEl = document.getElementById('bet');
        const msgEl = document.getElementById('message');
        const logoutBtn = document.getElementById('logoutBtn');

        const displayNameModal = document.getElementById('displayNameModal');
        const displayNameInput = document.getElementById('displayNameInput');
        const saveDisplayNameBtn = document.getElementById('saveDisplayNameBtn');

        const HARD_PRESS_DURATION = 500; // milliseconds for "hard press"
        let pressTimer;
        let isSpinning = false; // Flag to prevent rapid spins

        let balance = 1000;
        let currentUser = null; // Store the full Firebase User object
        let auth;
        let db; // Firestore instance

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase !== 'undefined') {
                if (firebase.apps.length === 0 && typeof firebaseConfig !== 'undefined') {
                    try {
                        firebase.initializeApp(firebaseConfig);
                    } catch (e) {
                        console.error(e);
                        msgEl.textContent = 'ERROR LOADING FIREBASE SERVICES.';
                        msgEl.className = 'lose';
                        spinBtn.disabled = true;
                        if (logoutBtn) logoutBtn.disabled = true;
                        // Keep betEl disabled initially if Firebase fails
                        betEl.disabled = true;
                        return;
                    }
                }
                auth = firebase.auth();
                db = firebase.firestore(); // Initialize Firestore

                auth.onAuthStateChanged(async user => {
                    if (!user) {
                        window.location.href = 'index.html';
                    } else {
                        currentUser = user; // Set the current user object
                        
                        // Check if display name is set
                        if (!currentUser.displayName) {
                            showDisplayNameModal();
                        } else {
                            // If display name is set, enable game and load leaderboards
                            enableGameControls();
                            loadLeaderboard('slotz', 'highestSlotz');
                            loadLeaderboard('risk', 'highestRisk');
                        }

                        if (logoutBtn) {
                            logoutBtn.addEventListener('click', () => {
                                auth.signOut().then(() => {
                                    window.location.href = 'index.html';
                                }).catch(err => alert('Error logging out.'));
                            });
                        }
                    }
                });
            } else {
                msgEl.textContent = 'FIREBASE SDK NOT LOADED. CANNOT PLAY.';
                msgEl.className = 'lose';
                spinBtn.disabled = true;
                if (logoutBtn) logoutBtn.disabled = true;
                // Keep betEl disabled if Firebase SDK is not loaded
                betEl.disabled = true;
            }
        });

        function enableGameControls() {
            spinBtn.disabled = false;
            betEl.disabled = false; // Ensure bet input is enabled here
            updateBalance();
        }

        function disableGameControls() {
            spinBtn.disabled = true;
            betEl.disabled = true;
        }

        async function showDisplayNameModal() {
            displayNameModal.classList.add('active');
            displayNameInput.focus();
            spinBtn.disabled = true; // Disable game controls until name is set
            betEl.disabled = true; // Also disable bet input here
        }

        saveDisplayNameBtn.addEventListener('click', async () => {
            const name = displayNameInput.value.trim();
            if (name.length < 3 || name.length > 20) {
                alert('Display name must be between 3 and 20 characters.');
                return;
            }

            try {
                // Update Firebase Auth profile
                await currentUser.updateProfile({ displayName: name });
                console.log('Firebase Auth display name updated.');

                // Update Firestore document for leaderboard
                const userRef = db.collection('users').doc(currentUser.email);
                await userRef.set({ username: name }, { merge: true });
                console.log('Firestore username updated.');

                displayNameModal.classList.remove('active');
                enableGameControls();
                // Reload leaderboards to show new name if applicable
                loadLeaderboard('slotz', 'highestSlotz');
                loadLeaderboard('risk', 'highestRisk');

            } catch (error) {
                console.error('Error setting display name:', error);
                alert('Failed to set display name. Please try again. ' + error.message);
            }
        });

        // Prevent Enter key from submitting the display name input
        displayNameInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveDisplayNameBtn.click(); // Programmatically click the save button
            }
        });


        function updateBalance() {
            balEl.textContent = balance;
        }

        function animateReel(el, duration, final) {
            const parent = el.parentElement;
            parent && parent.classList.add('spinning');
            return new Promise(res => {
                setTimeout(() => {
                    parent && parent.classList.remove('spinning');
                    el.textContent = final;
                    res(final);
                }, duration);
            });
        }

        function burstConfetti(){
            for(let i=0;i<30;i++){
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = (Math.random()*100)+'vw';
                c.style.setProperty('--dx', ((Math.random()*2-1)*100)+'vw');
                c.style.setProperty('--rot', (Math.random()*360)+'deg');
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 2000);
            }
        }

        async function updateLeaderboard(scoreType, scoreValue, betAmount) {
            if (!db || !currentUser || !currentUser.email || !currentUser.displayName) return; // Ensure user is fully logged in and has a display name

            const userRef = db.collection('users').doc(currentUser.email);

            try {
                await db.runTransaction(async (transaction) => {
                    const doc = await transaction.get(userRef);

                    let currentHighestSlotz = doc.exists ? (doc.data().highestSlotz || 0) : 0;
                    let currentHighestRisk = doc.exists ? (doc.data().highestRisk || 0) : 0;

                    const updates = {};
                    let updated = false;

                    if (scoreType === 'slotz' && scoreValue > currentHighestSlotz) {
                        updates.highestSlotz = scoreValue;
                        updated = true;
                    }

                    if (betAmount > currentHighestRisk) {
                        updates.highestRisk = betAmount;
                        updated = true;
                    }

                    if (updated) {
                        transaction.set(userRef, {
                            username: currentUser.displayName, // Always use the current display name
                            highestSlotz: updates.highestSlotz || currentHighestSlotz,
                            highestRisk: updates.highestRisk || currentHighestRisk
                        }, { merge: true });
                    }
                });
                console.log("Leaderboard data updated successfully!");
                // Reload leaderboards after successful update
                loadLeaderboard('slotz', 'highestSlotz');
                loadLeaderboard('risk', 'highestRisk');
            } catch (e) {
                console.error("Error updating leaderboard data: ", e);
            }
        }

        async function loadLeaderboard(leaderboardId, fieldName) {
            if (!db) return;

            const leaderboardListEl = document.getElementById(`leaderboard-${leaderboardId}`);
            leaderboardListEl.innerHTML = '<div style="text-align:center; padding: 10px;">Loading...</div>';

            try {
                const snapshot = await db.collection('users')
                    .where(fieldName, '>', 0)
                    .orderBy(fieldName, 'desc')
                    .limit(100)
                    .get();

                leaderboardListEl.innerHTML = ''; // Clear loading message

                if (snapshot.empty) {
                    leaderboardListEl.innerHTML = '<div style="text-align:center; padding: 10px;">No entries yet.</div>';
                    return;
                }

                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const username = data.username || doc.id.split('@')[0];
                    const score = data[fieldName];

                    const item = document.createElement('div');
                    item.classList.add('leaderboard-item');
                    item.innerHTML = `
                        <span class="rank">${index + 1}.</span>
                        <span class="username">${username}</span>
                        <span class="score">${score}</span>
                    `;
                    leaderboardListEl.appendChild(item);
                });
            } catch (e) {
                console.error(`Error loading ${leaderboardId} leaderboard: `, e);
                leaderboardListEl.innerHTML = '<div style="text-align:center; padding: 10px; color: var(--lose-message-color);">Error loading leaderboard.</div>';
            }
        }

        // --- Hard Press Spin Button Logic ---
        spinBtn.addEventListener('mousedown', (e) => {
            if (spinBtn.disabled || isSpinning) return;
            spinBtn.classList.add('pressing');
            pressTimer = setTimeout(async () => {
                // Only trigger spin if button is still pressed after duration
                if (spinBtn.classList.contains('pressing')) {
                    await handleSpin();
                }
            }, HARD_PRESS_DURATION);
        });

        spinBtn.addEventListener('mouseup', () => {
            clearTimeout(pressTimer);
            spinBtn.classList.remove('pressing');
        });

        spinBtn.addEventListener('mouseleave', () => {
            clearTimeout(pressTimer);
            spinBtn.classList.remove('pressing');
        });

        // For touch devices (equivalent to mousedown/mouseup)
        spinBtn.addEventListener('touchstart', (e) => {
            if (spinBtn.disabled || isSpinning) return;
            e.preventDefault(); // Prevent scrolling
            spinBtn.classList.add('pressing');
            pressTimer = setTimeout(async () => {
                if (spinBtn.classList.contains('pressing')) {
                    await handleSpin();
                }
            }, HARD_PRESS_DURATION);
        }, { passive: false }); // Use passive: false to allow preventDefault

        spinBtn.addEventListener('touchend', () => {
            clearTimeout(pressTimer);
            spinBtn.classList.remove('pressing');
        });

        spinBtn.addEventListener('touchcancel', () => {
            clearTimeout(pressTimer);
            spinBtn.classList.remove('pressing');
        });
        // --- End Hard Press Spin Button Logic ---

        // Prevent Enter key from triggering spin on bet input
        betEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Stop the default form submission/button click
            }
        });

        // Function to handle the actual spin logic
        async function handleSpin() {
            if (isSpinning) return; // Prevent multiple spins if function somehow gets called repeatedly
            isSpinning = true;
            disableGameControls(); // Disable controls immediately

            const bet = Number(betEl.value);
            if (!Number.isInteger(bet) || bet < 1 || bet > balance) {
                msgEl.textContent = 'PLEASE ENTER A VALID BET.';
                msgEl.className = 'lose';
                enableGameControls(); // Re-enable if invalid bet
                isSpinning = false;
                return;
            }

            balance -= bet;
            updateBalance();
            msgEl.textContent = '';
            msgEl.className = '';

            let finals;
            if (currentUser && currentUser.email && riggedToWinEmails.includes(currentUser.email)) {
                console.log(`Rigged WIN for ${currentUser.email}`);
                finals = generateRiggedWinOutcome(reelsData);
            } else if (currentUser && currentUser.email && riggedToLoseEmails.includes(currentUser.email)) {
                console.log(`Rigged LOSE for ${currentUser.email}`);
                finals = generateRiggedLoseOutcome(reelsData);
            } else {
                finals = reelsData.map((strip) => spinReelValue(strip));
            }

            const durations = [1200,1400,1600].map(d => d + Math.random()*300);
            const results = await Promise.all(finals.map((val,i) =>
                animateReel(reelsEls[i], durations[i], val)
            ));

            const counts = {};
            results.forEach(n => counts[n] = (counts[n]||0) + 1);

            let payout = 0, cls = '';
            let slotzScore = 0; // Initialize slotz score

            if (Object.values(counts).includes(3)) {
                payout = bet * 3;
                msgEl.textContent = 'ðŸŽ‰ JACKPOT! 3Ã— WIN!';
                cls = 'x3';
                slotzScore = results[0]; // If all three are same, the score is that number
            } else if (Object.values(counts).includes(2)) {
                payout = bet * 2;
                msgEl.textContent = 'âœ¨ NICE! 2Ã— WIN!';
                cls = 'x2';
                // If two are same, the score could be the value of the two matching reels
                for (const num in counts) {
                    if (counts[num] === 2) {
                        slotzScore = Number(num);
                        break;
                    }
                }
            } else {
                if (currentUser && currentUser.email && riggedToLoseEmails.includes(currentUser.email)) {
                    const insult = insultLossMessages[Math.floor(Math.random()*insultLossMessages.length)];
                    msgEl.textContent = insult;
                } else {
                    msgEl.textContent = 'ðŸ˜¢ YOU LOSE';
                }
                msgEl.className = 'lose';
                slotzScore = 0; // No win, score is 0
            }

            if (payout > 0) {
                msgEl.className = `win ${cls}`;
                burstConfetti();
            }
            balance += payout;
            updateBalance();

            // Update leaderboards with the new scores
            if (currentUser && currentUser.email && currentUser.displayName) {
                await updateLeaderboard('slotz', slotzScore, bet);
            }

            enableGameControls(); // Re-enable controls after spin is complete
            isSpinning = false;
        }

        // initial display
        updateBalance();
    </script>
</body>
</html>
