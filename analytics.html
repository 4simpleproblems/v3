<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4SP | Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="logo">4SP</div>
    <div class="nav-buttons">
      <a href="dashboard.html" class="btn secondary">Dashboard</a>
      <a href="#" class="btn secondary" id="logoutBtn">Log Out</a>
    </div>
  </nav>

  <main class="container">
    <div id="analyticsContent" class="analytics-content">
      <h1>Website Analytics</h1>
      <p id="authNotice">Checking Authentication...</p>
      <div id="adminContent" class="hidden">
        <p>Welcome, Admin! Here are your analytics:</p>
        <ul id="analyticsList">
          <li>Loading analytics...</li>
        </ul>
        <p id="noDataMessage" class="hidden" style="color: var(--error-red);">
          Missing or insufficient permissions.
        </p>
      </div>
      <p id="errorMessage" class="hidden" style="color: var(--error-red);"></p>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Firebase references from firebase-config.js
      const auth = window.auth;
      const db = window.db;
      const adminEmail = "4simpleproblems@gmail.com";

      const analyticsContent = document.getElementById("analyticsContent");
      const adminContent = document.getElementById("adminContent");
      const authNotice = document.getElementById("authNotice");
      const logoutBtn = document.getElementById("logoutBtn");
      const analyticsList = document.getElementById("analyticsList");
      const noDataMessage = document.getElementById("noDataMessage");
      const errorMessage = document.getElementById("errorMessage");

      function displayError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
      }

      logoutBtn.addEventListener("click", () => {
        auth
          .signOut()
          .then(() => {
            window.location.href = "index.html";
          })
          .catch((error) => {
            displayError("Sign out error: " + error.message);
          });
      });

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          if (user.email === adminEmail) {
            authNotice.classList.add("hidden");
            adminContent.classList.remove("hidden");
            await loadAnalytics();
          } else {
            window.location.href = "index.html";
          }
        } else {
          window.location.href = "index.html";
        }
      });

      // Helper: Format a key from camelCase or snake_case to Title Case
      function formatKey(key) {
        return key.replace(/[_\-]/g, ' ')
                  .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
                  .replace(/\b\w/g, c => c.toUpperCase());
      }

      async function loadAnalytics() {
        try {
          analyticsList.innerHTML = '<li>Loading analytics...</li>';
          noDataMessage.classList.add("hidden");

          // Aggregate statistics
          const stats = {};

          // Users collection: count
          try {
            const usersSnapshot = await db.collection("users").get();
            stats["Total Users"] = usersSnapshot.size;
          } catch (e) {
            stats["Total Users"] = "Permission Denied";
          }

          // Requests collection: count
          try {
            const requestsSnapshot = await db.collection("requests").get();
            stats["Total Requests"] = requestsSnapshot.size;
          } catch (e) {
            stats["Total Requests"] = "Permission Denied";
          }

          // Daily Analytics: show latest document's fields
          let dailyFieldsHtml = "";
          try {
            const dailySnapshot = await db
              .collection("dailyAnalytics")
              .orderBy("date", "desc")
              .limit(1)
              .get();

            if (!dailySnapshot.empty) {
              const latest = dailySnapshot.docs[0].data();
              stats["Latest Analytics Date"] = latest.date;
              Object.keys(latest).forEach((key) => {
                if (key !== "date") {
                  dailyFieldsHtml += `<li>${formatKey(key)} (Latest): ${latest[key]}</li>`;
                }
              });
            } else {
              dailyFieldsHtml += "<li>No daily analytics data found.</li>";
            }
          } catch (e) {
            dailyFieldsHtml += "<li>Cannot access daily analytics (Permission Denied)</li>";
          }

          // Render all stats as numbers in the list
          let statsHtml = "";
          Object.entries(stats).forEach(([key, value]) => {
            statsHtml += `<li>${key}: ${value}</li>`;
          });
          analyticsList.innerHTML = statsHtml + dailyFieldsHtml;

          noDataMessage.classList.add("hidden");
        } catch (error) {
          displayError("Error fetching analytics: " + error.message);
          analyticsList.innerHTML = "";
          noDataMessage.classList.remove("hidden");
        }
      }
    });
  </script>
</body>
</html>
