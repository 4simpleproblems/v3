<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4SP | Analytics</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Firebase scripts -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav class="navbar">
    <div class="logo">4SP</div>
    <div class="nav-buttons">
      <a href="dashboard.html" class="btn secondary">Dashboard</a>
      <a href="#" class="btn secondary" id="logoutBtn">Log Out</a>
    </div>
  </nav>

  <main class="container">
    <div id="analyticsContent" class="analytics-content">
      <h1>Website Analytics</h1>
      <p id="authNotice">Checking Authentication...</p>
      <div id="adminContent" class="hidden">
        <p>Welcome, Admin! Here are your analytics:</p>
        <ul id="analyticsList">
          <li>Loading analytics...</li>
        </ul>
        <div id="chartSection">
          <h2>Analytics Chart</h2>
          <canvas id="analyticsChart" width="400" height="200"></canvas>
        </div>
        <p id="noDataMessage" class="hidden" style="color: var(--error-red);">
          Missing or insufficient permissions.
        </p>
      </div>
      <p id="errorMessage" class="hidden" style="color: var(--error-red);"></p>
    </div>
  </main>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Firebase references from firebase-config.js
      const auth = firebase.auth();
      const db = firebase.firestore();
      const adminEmail = "4simpleproblems@gmail.com";

      const analyticsContent = document.getElementById("analyticsContent");
      const adminContent = document.getElementById("adminContent");
      const authNotice = document.getElementById("authNotice");
      const logoutBtn = document.getElementById("logoutBtn");
      const analyticsList = document.getElementById("analyticsList");
      const noDataMessage = document.getElementById("noDataMessage");
      const errorMessage = document.getElementById("errorMessage");

      function displayError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
      }

      logoutBtn.addEventListener("click", () => {
        auth
          .signOut()
          .then(() => {
            window.location.href = "index.html";
          })
          .catch((error) => {
            displayError("Sign out error: " + error.message);
          });
      });

      auth.onAuthStateChanged(async (user) => {
        if (user) {
          if (user.email === adminEmail) {
            authNotice.classList.add("hidden");
            adminContent.classList.remove("hidden");
            await loadAnalytics();
          } else {
            window.location.href = "index.html";
          }
        } else {
          window.location.href = "index.html";
        }
      });

      // Helper: Format a key from camelCase or snake_case to Title Case
      function formatKey(key) {
        return key.replace(/[_\-]/g, ' ')
                  .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
                  .replace(/\b\w/g, c => c.toUpperCase());
      }

      // Fetch and display analytics data from Firestore.
      async function loadAnalytics() {
        try {
          analyticsList.innerHTML = '<li>Loading analytics...</li>';
          noDataMessage.classList.add("hidden");

          // --- Aggregate statistics ---
          const stats = {};

          // Users collection: count and any additional fields
          const usersSnapshot = await db.collection("users").get();
          stats["Total Users"] = usersSnapshot.size;

          // Requests collection: count and any additional fields
          const requestsSnapshot = await db.collection("requests").get();
          stats["Total Requests"] = requestsSnapshot.size;

          // Add more collections as needed here

          // --- Historical daily analytics ---
          const dailySnapshot = await db
            .collection("dailyAnalytics")
            .orderBy("date")
            .get();

          let dates = [];
          let dailyFields = {}; // { fieldName: [values...] }

          dailySnapshot.forEach((doc) => {
            const data = doc.data();
            dates.push(data.date);

            // Collect all fields except 'date'
            Object.keys(data).forEach((key) => {
              if (key !== "date") {
                if (!dailyFields[key]) dailyFields[key] = [];
                dailyFields[key].push(data[key]);
              }
            });
          });

          // --- Display all stats ---
          let statsHtml = "";
          Object.entries(stats).forEach(([key, value]) => {
            statsHtml += `<li>${key}: ${value}</li>`;
          });

          // Show most recent dailyAnalytics document's fields as current stats
          if (dailySnapshot.size > 0) {
            const lastDoc = dailySnapshot.docs[dailySnapshot.size - 1].data();
            Object.keys(lastDoc).forEach((key) => {
              if (key !== "date") {
                statsHtml += `<li>${formatKey(key)} (Latest): ${lastDoc[key]}</li>`;
              }
            });
          }

          analyticsList.innerHTML = statsHtml;

          // --- Chart all numeric fields from dailyAnalytics ---
          if (dates.length > 0 && Object.keys(dailyFields).length > 0) {
            renderAnalyticsChart(dates, dailyFields);
          } else {
            document.getElementById("chartSection").innerHTML =
              '<p>No historical data available for chart.</p>';
          }

          noDataMessage.classList.add("hidden");
        } catch (error) {
          displayError("Error fetching analytics: " + error.message);
          analyticsList.innerHTML = "";
          noDataMessage.classList.remove("hidden");
        }
      }

      // Render the analytics chart using Chart.js.
      function renderAnalyticsChart(labels, fieldsData) {
        const ctx = document.getElementById("analyticsChart").getContext("2d");
        // Generate a color palette
        const palette = [
          "rgba(98,108,214,1)", // blue
          "rgba(255,51,51,1)",  // red
          "rgba(51,204,51,1)",  // green
          "rgba(255,204,0,1)",  // yellow
          "rgba(153,51,255,1)", // purple
          "rgba(255,102,0,1)",  // orange
        ];
        let colorIdx = 0;

        // Prepare datasets for each field
        const datasets = Object.entries(fieldsData).map(([field, dataArr]) => {
          const color = palette[colorIdx % palette.length];
          colorIdx++;
          return {
            label: formatKey(field),
            data: dataArr,
            borderColor: color,
            backgroundColor: color.replace('1)', '0.2)'),
            fill: true,
            tension: 0.4
          };
        });

        new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            scales: {
              x: {
                title: {
                  display: true,
                  text: "Date"
                }
              },
              y: {
                title: {
                  display: true,
                  text: "Count"
                },
                beginAtZero: true
              }
            }
          }
        });
      }
    });
  </script>
</body>
</html>
