<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4SP | Playlist Details</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    * { font-family: 'Roboto Mono', monospace; box-sizing: border-box; }

    :root {
      --dark-bg: #1a1a1a;
      --light-text: #f0f0f0;
      --white: #fff;
      --pill-radius: 50px;
      --darker-bg: #121212;
      --light-gray: #ccc;
    }

    body { margin: 0; background: var(--white); color: var(--dark-bg); }

    .navbar { display: flex; justify-content: space-between; align-items: center; background: var(--dark-bg); color: var(--light-text); padding: 1rem 2rem; }
    .logo-section { display: flex; align-items: center; gap: 1rem; }
    .logo { font-size: 1.5rem; font-weight: bold; }
    .title-section h2 { margin: 0; font-size: 1.25rem; }
    .title-section p { margin: 0; font-size: .9rem; opacity: .8; }
    .nav-buttons { display: flex; gap: 1rem; }
    .btn { padding: .75rem 1.5rem; border-radius: var(--pill-radius); background: transparent; border: 2px solid var(--light-text); color: var(--light-text); cursor: pointer; font-weight: 500; transition: background .2s, color .2s; }
    .btn.big { padding: 1rem 2rem; font-size: 1.1rem; }
    .btn:hover { background: var(--light-text); color: var(--dark-bg); }

    /* Soundboard-style grid & buttons */
    .sound-section { margin: 2rem; }
    .sound-section h2 { margin-bottom: .75rem; font-size: 1.5rem; padding-bottom: .5rem; border-bottom: 2px solid var(--dark-bg); }
    .soundButtonsContainer { display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 1rem; padding: 1rem; }
    .sound-button { min-width: 100px; height: 100px; border-radius: var(--pill-radius); background: var(--light-text); color: var(--dark-bg); border: 2px solid var(--dark-bg); display: flex; align-items: center; justify-content: center; text-align: center; padding: 0 1.5rem; font-size: .85rem; font-weight: bold; transition: background-color .3s ease, transform .1s ease; max-width: 250px; word-wrap: break-word; hyphens: auto; cursor: pointer; }
    .sound-button.short-text { width: 100px; padding: .5rem; border-radius: 50%; }
    .sound-button:hover { background: var(--light-gray); }
    .sound-button:active { transform: scale(0.95); }

    /* Overlay & Status Animations */
    .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:1; }
    .overlay.fade-in { display:block; animation:fadeInOverlay .3s ease forwards; }
    .overlay.fade-out { display:block; animation:fadeOutOverlay .3s ease forwards; }
    @keyframes fadeInOverlay { from {opacity:0;} to{opacity:1;} }
    @keyframes fadeOutOverlay { from{opacity:1;} to{opacity:0;} }

    .status-message { display:none; margin:1rem auto; padding:.5rem 1rem; border-radius:var(--pill-radius); max-width:80%; text-align:center; }
    .status-message.fade-in { display:block; animation:fadeInUp .3s ease forwards; }
    .status-message.fade-out { display:block; animation:fadeOutDown .3s ease forwards; }
    @keyframes fadeInUp { from{opacity:0;transform:translateY(20px);} to{opacity:1;transform:translateY(0);} }
    @keyframes fadeOutDown { from{opacity:1;transform:translateY(0);} to{opacity:0;transform:translateY(20px);} }
    .status-message.success { background:rgba(0,255,0,0.1); color:green; border:1px solid green; }
    .status-message.error { background:rgba(255,0,0,0.1); color:red; border:1px solid red; }
    .status-message.info { background:rgba(0,0,255,0.1); color:blue; border:1px solid blue; }

    /* Options Dropdown Animations */
    .options-dropdown { position: relative; display: inline-block; }
    .options-button { background: transparent; color: var(--light-text); padding: .75rem 1.5rem; font-size: 1rem; border: 2px solid var(--light-text); border-radius: var(--pill-radius); cursor: pointer; }
    .options-content { display: none; position: absolute; right: 0; background: var(--darker-bg); min-width: 250px; border: 2px solid var(--light-text); padding: 1rem; border-radius: 30px; z-index: 2; }
    .options-content.fade-in { display: block; animation:fadeIn .3s ease forwards; }
    .options-content.fade-out { display: block; animation:fadeOut .3s ease forwards; }
    @keyframes fadeIn { from{opacity:0;transform:translateY(-20px);} to{opacity:1;transform:translateY(0);} }
    @keyframes fadeOut { from{opacity:1;transform:translateY(0);} to{opacity:0;transform:translateY(-20px);} }
  </style>
</head>

<body>
  <nav class="navbar">
    <div class="logo-section">
      <div class="logo">4SP</div>
      <div class="title-section">
        <h2 id="plName"></h2>
        <p id="plDesc"></p>
      </div>
    </div>
    <div class="nav-buttons">
      <div class="options-dropdown">
        <button class="btn big options-button">Options</button>
        <div class="options-content" id="optionsMenu">
          <div class="options-section">
            <h3>Playback Options</h3>
            <label><input type="checkbox" id="soundOverlayCheckbox" /> Sound Overlay</label>
            <label><input type="checkbox" id="autoClickerCheckbox" /> Auto Clicker</label>
            <label id="autoClickDelayLabel" style="display:none;">Delay (ms): <input type="number" id="autoClickDelay" value="1000" min="0" /><button id="applyDelayBtn">Apply</button></label>
          </div>
          <div class="options-section">
            <h3>Management</h3>
            <button id="clearAllSoundsBtn" class="btn secondary">Clear All Sounds<div class="ripple-container"></div></button>
          </div>
          <div class="keyboard-shortcuts">
            <p><strong>Keyboard Shortcuts:</strong></p>
            <p>Shift + C: Mute & clear all sounds</p>
          </div>
        </div>
      </div>
      <button id="saveBtn" class="btn big" style="display:none;">Save</button>
      <button id="backBtn" class="btn big">Playlists</button>
      <button id="logoutBtn" class="btn big">Log Out</button>
    </div>
  </nav>

  <main class="container">
    <div class="status-message" id="statusMessage"></div>
    <div class="overlay" id="overlay"></div>

    <section class="sound-section">
      <h2>Playlist Sounds</h2>
      <div id="soundGrid" class="soundButtonsContainer"></div>
    </section>
  </main>

  <script>
    const auth = firebase.auth(), db = firebase.firestore();
    const params = new URLSearchParams(location.search);
    const playlistId = params.get('id');
    const isLocal = params.get('local') === 'true';
    let data = { items: [] };
    const plName = document.getElementById('plName'), plDesc = document.getElementById('plDesc');
    const grid = document.getElementById('soundGrid');
    const overlay = document.getElementById('overlay');
    const soundOverlayCheckbox = document.getElementById('soundOverlayCheckbox');
    const autoClickerCheckbox = document.getElementById('autoClickerCheckbox');
    const autoClickDelayInput = document.getElementById('autoClickDelay');
    const autoClickDelayLabel = document.getElementById('autoClickDelayLabel');
    const applyDelayBtn = document.getElementById('applyDelayBtn');
    const optionsButton = document.querySelector('.options-button');
    const optionsMenu = document.getElementById('optionsMenu');
    const statusMessage = document.getElementById('statusMessage');
    const clearAllSoundsBtn = document.getElementById('clearAllSoundsBtn');
    const rippleContainer = clearAllSoundsBtn.querySelector('.ripple-container');
    let playingAudios = [], autoClickInterval, requestAnimationFrameId = null, currentlyHoveredButton = null, statusMessageTimeout = null, menuIsOpen = false, isRippling = false;

    auth.onAuthStateChanged(async user => {
      if (!user) return location.href='index.html';
      if (isLocal) {
        const list = JSON.parse(localStorage.getItem('localPlaylists')||'[]'); data = list.find(p=>p.id===playlistId)||{};
      } else {
        const doc = await db.collection('playlists').doc(playlistId).get();
        if (!doc.exists||doc.data().owner!==user.uid) return location.href='playlist.html'; data = doc.data();
      }
      plName.textContent=data.name; plDesc.textContent=data.description; render();
    });

    function render() {
      grid.innerHTML = '';
      data.items.forEach((item,i) => {
        const btn = document.createElement('button'); btn.className = 'sound-button';
        const label = item.label||item.fileName; btn.textContent = label;
        if (label.length < 8) btn.classList.add('short-text');
        btn.onclick = () => playSound(item);
        grid.appendChild(btn);
      });
    }

    function playSound(sound) {
      const url = sound.url||`${sound.folder}/${sound.fileName}`;
      const audio = new Audio(url);
      if (!soundOverlayCheckbox.checked) { playingAudios.forEach(a=>a.pause()); playingAudios=[audio]; }
      else { playingAudios.push(audio); audio.addEventListener('ended',()=>{ playingAudios = playingAudios.filter(a=>a!==audio); }); }
      audio.play();
    }

    // Options menu toggle
    function openOptionsMenu() { if (menuIsOpen) return; menuIsOpen=true; overlay.style.display='block'; overlay.classList.add('fade-in'); optionsMenu.style.display='block'; optionsMenu.classList.add('fade-in'); }
    function closeOptionsMenu() { if (!menuIsOpen) return; menuIsOpen=false; overlay.classList.remove('fade-in'); overlay.classList.add('fade-out'); optionsMenu.classList.remove('fade-in'); optionsMenu.classList.add('fade-out'); setTimeout(()=>{ overlay.style.display='none'; overlay.classList.remove('fade-out'); optionsMenu.style.display='none'; optionsMenu.classList.remove('fade-out'); },300); }
    optionsButton.addEventListener('click',()=> menuIsOpen?closeOptionsMenu():openOptionsMenu());
    window.addEventListener('click',e=>{ if (!optionsMenu.contains(e.target)&&!optionsButton.contains(e.target)&&menuIsOpen) closeOptionsMenu(); });

    // Auto Clicker
    applyDelayBtn.addEventListener('click',()=>{ stopAutoClicker(); startAutoClicker(); });
    autoClickerCheckbox.addEventListener('change',()=>{ autoClickDelayLabel.style.display = autoClickerCheckbox.checked ? 'block':'none'; if (autoClickerCheckbox.checked) startAutoClicker(); else stopAutoClicker(); });
    function startAutoClicker(){ stopAutoClicker(); const delay = parseInt(autoClickDelayInput.value,10)||0; if(delay===0){ requestAnimationFrameId=requestAnimationFrame(fastClick);} else { autoClickInterval=setInterval(()=>{ if(currentlyHoveredButton) currentlyHoveredButton.click(); },delay); } }
    function stopAutoClicker(){ if(autoClickInterval) clearInterval(autoClickInterval); if(requestAnimationFrameId) cancelAnimationFrame(requestAnimationFrameId); }
    function fastClick(){ if(currentlyHoveredButton&&autoClickerCheckbox.checked){ currentlyHoveredButton.click(); requestAnimationFrameId=requestAnimationFrame(fastClick);} }
    document.addEventListener('mouseover',e=>{ if(e.target.classList.contains('sound-button')) currentlyHoveredButton=e.target; });
    document.addEventListener('mouseout',e=>{ if(e.target.classList.contains('sound-button')) currentlyHoveredButton=null; });

    // Clear All Sounds
    clearAllSoundsBtn.addEventListener('click',e=>{ createRipple(e); clearAll(); });
    function clearAll(){ playingAudios.forEach(a=>a.pause()); playingAudios=[]; showStatus('All sounds cleared','info'); }
    function createRipple(e){ if(isRippling) return; isRippling=true; const circle=document.createElement('span'), d=Math.max(clearAllSoundsBtn.clientWidth,clearAllSoundsBtn.clientHeight), r=d/2; circle.style.width=circle.style.height=`${d}px`; circle.style.left=`${e.clientX-(clearAllSoundsBtn.offsetLeft+r)}px`; circle.style.top=`${e.clientY-(clearAllSoundsBtn.offsetTop+r)}px`; circle.classList.add('ripple'); rippleContainer.appendChild(circle); setTimeout(()=>{ circle.remove(); isRippling=false; },600); }

    // Status messages
    function showStatus(msg,type){ if(statusMessageTimeout){ clearTimeout(statusMessageTimeout); statusMessage.classList.remove('fade-in','fade-out'); } statusMessage.textContent=msg; statusMessage.className=`status-message ${type}`; statusMessage.style.display='block'; statusMessage.classList.add('fade-in'); statusMessageTimeout=setTimeout(()=>{ statusMessage.classList.remove('fade-in'); statusMessage.classList.add('fade-out'); setTimeout(()=>{ statusMessage.style.display='none'; statusMessage.classList.remove('fade-out'); },300); },3000); }

    // Keyboard shortcut
    document.addEventListener('keydown',e=>{ if(e.shiftKey&&e.key.toLowerCase()==='c'){ clearAll(); closeOptionsMenu(); } });

    // Back & Logout & Save
    document.getElementById('backBtn').onclick=()=>location.href='playlist.html';
    document.getElementById('logoutBtn').onclick=()=>auth.signOut().then(()=>location.href='index.html');
    document.getElementById('saveBtn').onclick=async()=>{ data.name=plName.textContent.trim(); data.description=plDesc.textContent.trim(); if(!isLocal) await db.collection('playlists').doc(playlistId).update({ name:data.name,description:data.description,items:data.items }); else{ const lst=JSON.parse(localStorage.getItem('localPlaylists')||'[]'); localStorage.setItem('localPlaylists',JSON.stringify(lst.map(p=>p.id===playlistId?data:p))); } closeEdit(); };

    // Render on load complete
  </script>
</body>

</html>
